# ------------------------------------------------------------
# Real-Time Fruit Detection with Ultralytics-YOLOv12
# NVIDIA Jetson Orin Nano iÃ§in Optimize EdilmiÅŸ SÃ¼rÃ¼m
# ------------------------------------------------------------
import sys
import os
import yaml
import time
import logging
from pathlib import Path
from collections import Counter
import cv2
import torch
from ultralytics import YOLO

logging.basicConfig(level=logging.INFO, format="%(levelname)s - %(message)s")

# ---------- YOL AYARLARI (Ä°STEÄÄ°NÄ°Z ÃœZERÄ°NE DEÄÄ°ÅTÄ°RÄ°LMEDÄ°) -------------------
# !!! DÄ°KKAT: Bu kodu Jetson'da Ã§alÄ±ÅŸtÄ±rÄ±rken bu Windows yollarÄ±nÄ±
# Jetson'daki (Linux) dosya yapÄ±nÄ±za gÃ¶re GÃœNCELLEMENÄ°Z GEREKÄ°R.
# Ã–rnek: ROOT_DIR = Path("/home/jetson/Desktop/Fruits-detection")
ROOT_DIR      = Path(r"C:\Users\ASUS\Desktop\Fruits-detection")
DATA_YAML     = ROOT_DIR / "data.yaml"
# Model adÄ±nÄ± yolo12s olarak gÃ¼ncelledik
MODEL_PATH_ENGINE = ROOT_DIR / "yolo12s_fruit_detector.engine"
SPLITS        = ("train", "valid", "test")
IMG_EXT       = {".jpg", ".jpeg", ".png"}
CAMERA_INDEX  = 1
# ---------------------------------------------------------------------------

def sanity_check() -> None:
    """
    *images/labels* eÅŸleÅŸmesini denetler, .cache dosyalarÄ±nÄ± temizler.
    Eksik veya BOÅ etiket varsa programÄ± sonlandÄ±rÄ±r.
    """
    ok = True
    for split in SPLITS:
        img_dir = ROOT_DIR / split / "images"
        lbl_dir = ROOT_DIR / split / "labels"
        if not img_dir.exists() or not lbl_dir.exists():
            logging.error("âŒ %s altÄ±nda images / labels klasÃ¶rÃ¼ eksik!", split)
            sys.exit(1)
        imgs  = [p for p in img_dir.rglob("*") if p.suffix.lower() in IMG_EXT]
        miss, empty = 0, 0
        for p in imgs:
            rel   = p.relative_to(img_dir).with_suffix(".txt")
            lbl_p = lbl_dir / rel
            if not lbl_p.exists():
                miss += 1
            elif lbl_p.stat().st_size == 0:
                empty += 1
        logging.info("%s â†’ %d gÃ¶rÃ¼ntÃ¼ | %d eksik etiket | %d boÅŸ etiket",
                     split, len(imgs), miss, empty)
        if miss or empty:
            ok = False

    for c in ROOT_DIR.rglob("*.cache"):
        c.unlink(missing_ok=True)
        
    if not ok:
        logging.error("Eksik/boÅŸ etiketler var â†’ Ã¶nce veri kÃ¼mesini dÃ¼zeltin!")
        sys.exit(1)

# ---------------------------------------------------------------------------
def load_and_optimize_yolo12() -> YOLO:
    """
    Ã–nce optimize edilmiÅŸ YOLOv12 TensorRT (.engine) modelini arar.
    Bulamazsa, Ã¶nceden eÄŸitilmiÅŸ YOLOv12s (.pt) modelini indirir
    ve onu Jetson iÃ§in maksimum FPS saÄŸlayacak TensorRT formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
    """
    # 1. AdÄ±m: Optimize edilmiÅŸ TensorRT modelini kontrol et
    if MODEL_PATH_ENGINE.exists():
        logging.info("âœ… Optimize EdilmiÅŸ TensorRT modeli bulundu (%s), yÃ¼kleniyor...", MODEL_PATH_ENGINE.name)
        return YOLO(str(MODEL_PATH_ENGINE))

    # 2. AdÄ±m: YOLOv12s modelini yÃ¼kle ve TensorRT'ye dÃ¶nÃ¼ÅŸtÃ¼r
    logging.info("TensorRT modeli bulunamadÄ±. YOLOv12s modeli yÃ¼klenip TensorRT formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lecek.")
    logging.info("Bu iÅŸlem birkaÃ§ dakika sÃ¼rebilir, lÃ¼tfen bekleyin...")
    
    # Ultralytics kÃ¼tÃ¼phanesi 'yolo12s.pt' modelini otomatik olarak indirecektir.
    model_to_export = YOLO("yolo12s.pt")
    
    # Modeli Jetson'da maksimum performans iÃ§in TensorRT'ye Ã§eviriyoruz.
    # 'device=0' Jetson'un GPU'sunu kullanÄ±r.
    # 'half=True' FP16 hassasiyeti ile hÄ±zÄ± artÄ±rÄ±r.
    model_to_export.export(
        format="engine",
        half=True,
        imgsz=640,
        device=0,
        workspace=4 # Jetson Orin Nano belleÄŸine gÃ¶re (GB)
    )
    
    # export iÅŸlemi sonrasÄ± oluÅŸan .engine dosyasÄ±nÄ±n adÄ±nÄ± bizim belirlediÄŸimiz yola taÅŸÄ±yoruz.
    # Ultralytics normalde modeli Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ± dizine 'yolo12s.engine' olarak kaydeder.
    default_engine_path = Path("./yolo12s.engine")
    if default_engine_path.exists():
        default_engine_path.rename(MODEL_PATH_ENGINE)
        logging.info("âœ… Model baÅŸarÄ±yla TensorRT formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼ â†’ %s", MODEL_PATH_ENGINE.name)
    else:
        logging.error("âŒ TensorRT motor dosyasÄ± oluÅŸturulamadÄ±! 'ultralytics' kÃ¼tÃ¼phanesinin gÃ¼ncel olduÄŸundan emin olun.")
        sys.exit(1)

    return YOLO(str(MODEL_PATH_ENGINE))
    
# ---------------------------------------------------------------------------
def realtime_detection(model: YOLO, camera_index: int = CAMERA_INDEX) -> None:
    """
    USB kamerayÄ± aÃ§ar ve optimize edilmiÅŸ modelle gerÃ§ek-zamanlÄ± meyve tespiti yapar.
    """
    with open(DATA_YAML, "r", encoding="utf-8") as f:
        classes = yaml.safe_load(f)["names"]

    cap = cv2.VideoCapture(camera_index)
    if not cap.isOpened():
        logging.error("âš ï¸  Kamera aÃ§Ä±lamadÄ±! (index=%d)", camera_index)
        return

    prev_time = time.time()
    logging.info("ğŸš€ GerÃ§ek zamanlÄ± tespit baÅŸlatÄ±ldÄ±. Ã‡Ä±kmak iÃ§in 'q' tuÅŸuna basÄ±n.")
    
    # 'stream=True' bellek kullanÄ±mÄ±nÄ± optimize eder ve sÃ¼rekli video akÄ±ÅŸlarÄ± iÃ§in daha verimlidir.
    for r in model.stream(source=camera_index, stream=True, conf=0.25, iou=0.45):
        frame = r.orig_img
        detected = []
        for box in r.boxes:
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            conf = float(box.conf[0])
            cls_id = int(box.cls[0])
            if cls_id < len(classes):
                label = f"{classes[cls_id]}: {conf:.2f}"
                detected.append(classes[cls_id])
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                cv2.putText(frame, label, (x1, y1 - 10),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)

        for i, (fruit, cnt) in enumerate(Counter(detected).items()):
            cv2.putText(frame, f"{fruit}: {cnt}", (10, 60 + i * 30),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255, 255, 0), 2)

        now = time.time()
        fps = 1 / (now - prev_time + 1e-6)
        prev_time = now
        cv2.putText(frame, f"FPS: {fps:.2f}", (10, 30),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.9, (0, 0, 255), 2)

        cv2.imshow("YOLOv12s Jetson - Real-Time Detection (press q to quit)", frame)

        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

    cap.release()
    cv2.destroyAllWindows()
# ---------------------------------------------------------------------------
def main() -> None:
    # sanity_check() fonksiyonu etiket dosyalarÄ±nÄ± kontrol eder.
    # EÄŸer Ã¶zel bir veri setiniz yoksa ve sadece COCO sÄ±nÄ±flarÄ±nÄ± kullanacaksanÄ±z
    # bu adÄ±mÄ± geÃ§ici olarak yorum satÄ±rÄ± yapabilirsiniz.
    # sanity_check()
    model = load_and_optimize_yolo12()
    # `realtime_detection` iÃ§indeki `model.stream` zaten kamerayÄ± kullanÄ±yor,
    # bu yÃ¼zden ayrÄ± bir fonksiyon Ã§aÄŸÄ±rmaya gerek yok.
    realtime_detection(model)
# ---------------------------------------------------------------------------
if __name__ == "__main__":
    main()
